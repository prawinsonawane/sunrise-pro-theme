{%- liquid
  assign media_id = media.id
  assign media_type = media.media_type
  assign media_alt = media.alt | default: product.title | escape
  assign media_width = media.width | default: 800
  assign media_height = media.height | default: 600
  assign media_aspect_ratio = media.aspect_ratio | default: 1.0
  assign media_sources = media.sources
  assign media_poster = media.preview_image
  assign show_zoom = show_zoom | default: false
  assign lazy_load = lazy_load | default: true
  assign class = class | default: ''
-%}

<div class="sunrise-media sunrise-media--{{ media_type }}{% if class %} {{ class }}{% endif %}" data-media-id="{{ media_id }}" data-media-type="{{ media_type }}">
  {%- case media_type -%}
    {%- when 'image' -%}
      <div class="sunrise-media__image-container">
        {%- if show_zoom -%}
          <button class="sunrise-media__zoom-button" aria-label="Zoom image">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"/>
              <line x1="8" y1="11" x2="14" y2="11"/>
              <line x1="11" y1="8" x2="11" y2="14"/>
            </svg>
          </button>
        {%- endif -%}
        
        {%- if lazy_load -%}
          {{
            media
            | image_url: width: media_width
            | image_tag:
              class: 'sunrise-media__image',
              loading: 'lazy',
              widths: '165, 360, 533, 720, 940, 1066, 1280',
              height: media_height,
              width: media_width,
              alt: media_alt,
              data-zoom: show_zoom
          }}
        {%- else -%}
          {{
            media
            | image_url: width: media_width
            | image_tag:
              class: 'sunrise-media__image',
              loading: 'eager',
              widths: '165, 360, 533, 720, 940, 1066, 1280',
              height: media_height,
              width: media_width,
              alt: media_alt,
              data-zoom: show_zoom
          }}
        {%- endif -%}
      </div>

    {%- when 'video' -%}
      <div class="sunrise-media__video-container">
        <video
          class="sunrise-media__video"
          controls
          preload="metadata"
          poster="{{ media_poster | image_url: width: media_width }}"
          data-media-id="{{ media_id }}"
        >
          {%- for source in media_sources -%}
            <source src="{{ source.url }}" type="{{ source.mime_type }}">
          {%- endfor -%}
          <p>Your browser doesn't support HTML5 video.</p>
        </video>
        
        <button class="sunrise-media__play-button" aria-label="Play video">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="5,3 19,12 5,21"/>
          </svg>
        </button>
      </div>

    {%- when 'external_video' -%}
      <div class="sunrise-media__external-video-container">
        {%- if media.host == 'youtube' -%}
          <iframe
            class="sunrise-media__external-video sunrise-media__external-video--youtube"
            src="https://www.youtube.com/embed/{{ media.external_id }}?enablejsapi=1"
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen
            data-media-id="{{ media_id }}"
            data-host="{{ media.host }}"
            data-external-id="{{ media.external_id }}"
          ></iframe>
        {%- elsif media.host == 'vimeo' -%}
          <iframe
            class="sunrise-media__external-video sunrise-media__external-video--vimeo"
            src="https://player.vimeo.com/video/{{ media.external_id }}"
            frameborder="0"
            allow="autoplay; fullscreen; picture-in-picture"
            allowfullscreen
            data-media-id="{{ media_id }}"
            data-host="{{ media.host }}"
            data-external-id="{{ media.external_id }}"
          ></iframe>
        {%- endif -%}
        
        <button class="sunrise-media__play-button" aria-label="Play video">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="5,3 19,12 5,21"/>
          </svg>
        </button>
      </div>

    {%- when 'model' -%}
      <div class="sunrise-media__model-container">
        <model-viewer
          class="sunrise-media__model"
          src="{{ media.sources[1].url }}"
          alt="{{ media_alt }}"
          auto-rotate
          camera-controls
          data-media-id="{{ media_id }}"
        >
          <div class="sunrise-media__model-loading">
            <svg class="sunrise-media__model-spinner" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 12a9 9 0 11-6.219-8.56"/>
            </svg>
            <p>Loading 3D model...</p>
          </div>
        </model-viewer>
        
        <button class="sunrise-media__model-button" aria-label="View 3D model">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
            <polyline points="3.27,6.96 12,12.01 20.73,6.96"/>
            <line x1="12" y1="22.08" x2="12" y2="12"/>
          </svg>
          <span>View in 3D</span>
        </button>
      </div>

    {%- else -%}
      <div class="sunrise-media__placeholder">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
          <circle cx="8.5" cy="8.5" r="1.5"/>
          <polyline points="21,15 16,10 5,21"/>
        </svg>
        <p>Unsupported media type</p>
      </div>
  {%- endcase -%}
</div>

{%- if media_type == 'video' or media_type == 'external_video' -%}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const mediaContainer = document.querySelector('[data-media-id="{{ media_id }}"]');
      if (mediaContainer) {
        const playButton = mediaContainer.querySelector('.sunrise-media__play-button');
        const video = mediaContainer.querySelector('.sunrise-media__video, .sunrise-media__external-video');
        
        if (playButton && video) {
          playButton.addEventListener('click', function() {
            if (video.tagName === 'VIDEO') {
              video.play();
              playButton.style.display = 'none';
            } else if (video.tagName === 'IFRAME') {
              // For external videos, the iframe will handle playback
              playButton.style.display = 'none';
            }
          });
          
          // Show play button when video is paused
          if (video.tagName === 'VIDEO') {
            video.addEventListener('pause', function() {
              playButton.style.display = 'flex';
            });
          }
        }
      }
    });
  </script>
{%- endif -%}

{%- if media_type == 'model' -%}
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const modelContainer = document.querySelector('[data-media-id="{{ media_id }}"]');
      if (modelContainer) {
        const modelViewer = modelContainer.querySelector('model-viewer');
        const modelButton = modelContainer.querySelector('.sunrise-media__model-button');
        
        if (modelViewer && modelButton) {
          modelButton.addEventListener('click', function() {
            modelViewer.classList.add('sunrise-media__model--active');
            modelButton.style.display = 'none';
          });
          
          // Hide button when model is loaded
          modelViewer.addEventListener('load', function() {
            const loading = modelContainer.querySelector('.sunrise-media__model-loading');
            if (loading) {
              loading.style.display = 'none';
            }
          });
        }
      }
    });
  </script>
{%- endif -%}
